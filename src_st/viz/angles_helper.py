from typing import List, Any
from plotly.subplots import make_subplots
import plotly.graph_objects as go
import numpy as np
import pandas as pd


class AnglesHelper:
    def __init__(self, in_path: str):
        self.df = pd.read_csv(in_path, index_col=0)

    def viz(self):
        sequence = list(self.df.index)
        mcq_per_seq = self.df.values
        names = self.df.columns
        return self.plot_mcq_per_position(sequence, mcq_per_seq, names)

    @staticmethod
    def update_plot(fig: Any):
        params_axes = dict(
            showgrid=True,
            gridcolor="#d6d6d6",
            linecolor="black",
            zeroline=False,
            linewidth=1,
            showline=True,
            mirror=True,
            gridwidth=1,
            griddash="dot",
        )
        fig.update_xaxes(**params_axes)
        fig.update_yaxes(**params_axes)
        fig.update_layout(dict(plot_bgcolor="white"), margin=dict(l=0, r=5, b=0, t=20))
        fig.update_layout(
            font=dict(
                family="Computer Modern",
                size=26,
            )
        )
        return fig

    @staticmethod
    def plot_mcq_per_position(sequence: List, mcq_per_seq: List, names: List):
        z = np.array(mcq_per_seq)
        sequence = [f"{seq}_{i}" for i, seq in enumerate(sequence)]
        y = names
        fig = go.Figure(data=go.Heatmap(z=z.T, x=sequence, y=y, colorscale="Viridis"))
        fig.update_layout(
            xaxis=dict(title="Sequence Position"),
        )
        fig = AnglesHelper.update_plot(fig)
        return fig

    @staticmethod
    def get_viz(in_path):
        angles_helper = AnglesHelper(in_path)
        return angles_helper.viz()


if __name__ == "__main__":
    sequences, mcq_per_seq = (
        [
            "GGGGGCCACAGCAGAAGCGUUCACGUCGCAGCCCCUGUCAGCCAUUGCACUCCGGCUGCGAAUUCUGCU",
            "GGGGGCCACAGCAGAAGCGUUCACGUCGCAGCCCCUGUCAGCCAUUGCACUCCGGCUGCGAAUUCUGCU",
            "GGGGGCCACAGCAGAAGCGUUCACGUCGCAGCCCCUGUCAGCCAUUGCACUCCGGCUGCGAAUUCUGCU",
            "GGGGGCCACAGCAGAAGCGUUCACGUCGCAGCCCCUGUCAGCCAUUGCACUCCGGCUGCGAAUUCUGCU",
        ],
        [
            [
                16.79268209703439,
                8.371646910951101,
                8.124238393310309,
                7.244222144903927,
                28.087385359540946,
                4.620177644505845,
                5.124662313597029,
                6.856300404969538,
                7.245268681344804,
                23.25082292313026,
                10.496641450047766,
                8.993506233757467,
                7.123204159847815,
                6.622838473731091,
                10.879462222012922,
                28.823963800883295,
                28.363736105373544,
                6.871766131052726,
                7.118679665864965,
                28.95693262084326,
                20.232714004133342,
                23.452731537905173,
                39.78351544234209,
                13.888701406398951,
                15.466523927328652,
                31.474388140763015,
                29.99259209112309,
                13.134826955468208,
                7.250957907845569,
                7.873786686668703,
                7.618494490609644,
                5.990725375782181,
                14.178517983592215,
                10.842328966836313,
                38.681233788454556,
                14.228586752179526,
                22.519808538097887,
                9.99246845995322,
                26.39867011957639,
                19.640293821339753,
                42.60833581718755,
                117.96789819197907,
                67.06613613849954,
                61.14186238769755,
                45.930450996042545,
                58.54890962139351,
                73.77111071265708,
                59.41282204067127,
                39.93501366449203,
                16.359999839553254,
                24.219446282206512,
                111.50933448895842,
                42.54757980788557,
                28.45356518784536,
                6.2462038820175065,
                6.615434059565091,
                6.373461385164377,
                6.120022418328573,
                14.656867805228822,
                8.974332823903548,
                44.956914080458944,
                13.966941562228309,
                14.999845635337781,
                23.263597218929842,
                9.22437888466829,
                6.997560928780151,
                6.495245535132958,
            ],
            [
                4.8334227101037275,
                4.250138252266602,
                5.247639964961714,
                5.749880737797599,
                1.9993525125780025,
                1.6247791994497764,
                18.785735959994152,
                37.84488111494256,
                60.42089287998515,
                27.878536773320057,
                9.229285746163006,
                6.735582337905604,
                6.870576199228938,
                9.502753146484213,
                8.620407440099452,
                15.430620785538494,
                13.206650926584862,
                2.998170391770774,
                5.6254938281925915,
                4.749214233539637,
                6.248974528212835,
                7.747918131207431,
                13.705190530081701,
                9.375845526612974,
                15.296153129543564,
                9.244092138330657,
                6.746101648444204,
                9.19423660539881,
                4.498779997629401,
                4.61861973928762,
                2.374530431855637,
                3.372687312578318,
                2.874556374379267,
                2.8747850612763273,
                7.498415639309849,
                7.8631533303314995,
                12.344495808976433,
                19.307949152941724,
                15.58271833861402,
                4.873770942585202,
                4.741857009391494,
                2.2499285894310836,
                3.87089138027163,
                3.9971045183053078,
                5.747926316015739,
                30.749734013159088,
                25.160139091796964,
                51.71172978361765,
                10.365040497836748,
                14.89080341587672,
                25.392547084296123,
                8.967427495533082,
                9.497540952322161,
                6.367316083294977,
                4.245506483214511,
                3.495198139706607,
                1.1249767946157618,
                2.8741847728621064,
                12.90696566845765,
                5.749671365460201,
                13.624345024713373,
                44.2337448415116,
                20.193060136282863,
                23.34436091650773,
                10.870738084228464,
                3.374201810223752,
                4.868873921448741,
            ],
            [
                5.666095251666208,
                7.249701114192263,
                7.617395136777271,
                4.624450237229183,
                1.6249553720910572,
                2.375082738267768,
                2.2498238193532667,
                5.3733426461712375,
                3.6228168556047837,
                29.440365796724368,
                9.362972518350315,
                9.37444301127075,
                7.991935744525802,
                8.605995365023531,
                10.125857461466289,
                13.506717699251292,
                15.68547133826707,
                5.749155943072197,
                5.7456920209050315,
                5.369045602031242,
                13.20803683241244,
                40.21080310773969,
                14.689499928640531,
                15.619147684957513,
                46.13255687221333,
                25.877449975727554,
                13.613584437850555,
                12.350532247567624,
                10.584921103967377,
                13.106215723484874,
                26.127594317573067,
                5.247430980775925,
                4.125191210687485,
                5.620663442403127,
                8.623874157958873,
                12.002868366509578,
                20.81626921386023,
                14.62806903922735,
                11.946169862887047,
                4.499313809582188,
                6.9648056176026785,
                2.749642892762741,
                3.9969870085373866,
                5.875137490042304,
                4.249357187496113,
                11.537258747691167,
                20.635956225327515,
                9.452953552930714,
                12.12383011759591,
                15.348982919589151,
                26.40149763934616,
                13.222622232708714,
                14.785055501416794,
                11.108395040881032,
                3.1223190446669693,
                4.124529069632319,
                2.7500238168191515,
                4.375063757889045,
                22.50233076948713,
                30.94688474122696,
                32.89059314234698,
                16.43462438565452,
                58.33371790252766,
                47.49230600018094,
                9.106751797147844,
                4.749175226966439,
                4.734621468494017,
            ],
            [
                31.771780470560863,
                42.51661153392009,
                71.22858673179701,
                51.45274466242353,
                35.408757731653054,
                40.52650181885224,
                28.826586052028226,
                48.37705292332567,
                47.42067981663409,
                70.96512334019012,
                30.298264838435436,
                36.4365206141965,
                40.07252083705101,
                57.26534172963813,
                13.371768169063536,
                34.924891210262125,
                38.91166398556456,
                12.057527263597935,
                21.712207412898607,
                69.06441095209834,
                56.270755835858225,
                58.3725087881251,
                47.70199841412801,
                41.6535731783792,
                74.94011137390378,
                73.3689708554057,
                71.0398184934512,
                45.64872859721646,
                34.264639392609936,
                79.77482269511788,
                34.176613562063714,
                51.38988126090712,
                43.74909902212985,
                55.474601187679696,
                46.76391717285505,
                21.105983983620536,
                99.70219866731708,
                57.38270765411015,
                101.82386199747168,
                82.1096935470969,
                73.9500137823246,
                26.449612061145096,
                47.78736229354605,
                47.980299583608485,
                92.10327090895065,
                106.98401015254152,
                81.20182799081381,
                81.07072006347347,
                45.640379131839424,
                58.04550153397242,
                70.29459519073649,
                51.18036371855067,
                30.893858230368643,
                50.987862716036666,
                44.138441542708556,
                38.50268181753225,
                78.13901576247841,
                43.44931449122611,
                18.99476120035878,
                57.18179037827475,
                88.46545639976311,
                83.46298415898309,
                24.957875289672227,
                23.454021676036984,
                78.51293479664014,
                86.4914488836972,
                69.41175698071021,
            ],
        ],
    )
    names = [
        "3drna_r1107_1.pdb",
        "alphafold3_R1107_1.pdb",
        "best_R1107_1.pdb",
        "rhofold_r1107.pdb",
    ]
    out_path = "out_tb_mcq.csv"
    # save_mcq_per_seq(sequences, mcq_per_seq, names, out_path)

    # AnglesHelper.plot_mcq_per_position(sequences, mcq_per_seq, names)
    AnglesHelper.get_viz("data/user/tmp_85604/output/out_tb_mcq.csv")
    # AnglesHelper.plot_mcq_per_angle("data/user/tmp_85508/output/out_tb_mcq_per_angle.csv")
